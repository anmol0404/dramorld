"use strict";(()=>{var e={};e.id=589,e.ids=[589],e.modules={1185:e=>{e.exports=require("mongoose")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8810:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>m,requestAsyncStorage:()=>g,routeModule:()=>c,serverHooks:()=>y,staticGenerationAsyncStorage:()=>p});var s={};r.r(s),r.d(s,{GET:()=>l,POST:()=>u});var a=r(9303),i=r(8716),n=r(3131),o=r(7070),d=r(2681);async function u(e){try{let{shareId:t,messageIds:r,token:s=""}=await e.json();if(await d.Z.addAIO(t,r))return o.NextResponse.json({message:"Messages added to AIO"},{status:200});return o.NextResponse.json({error:"AIO not found"},{status:404})}catch(e){return o.NextResponse.json({error:"Failed to add messages to AIO"},{status:500})}}async function l(){return o.NextResponse.json({message:"Method not allowed"},{status:405})}let c=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/bot/add-aio/route",pathname:"/api/bot/add-aio",filename:"route",bundlePath:"app/api/bot/add-aio/route"},resolvedPagePath:"D:\\Tele Projects\\website work\\Next Website\\dramorld\\src\\app\\api\\bot\\add-aio\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:p,serverHooks:y}=c,h="/api/bot/add-aio/route";function m(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:p})}},2681:(e,t,r)=>{r.d(t,{Z:()=>v});var s=r(1185),a=r.n(s);let i=require("process"),n=new s.Schema({userId:{type:String,required:!0},invites:[{username:{type:String,required:!0},userId:{type:String,required:!0}}],lastRequestDate:{type:Date,default:Date.now},dailyRequests:{type:Number,default:5}}),o=a().models.InviteUser||a().model("InviteUser",n);class d{async addInvite(e,t,r){let s=await o.findOne({userId:e});if(s||(s=new o({userId:e,invites:[],lastRequestDate:new Date(0),dailyRequests:5})),s.invites.some(e=>e.username===t))throw Error("User already invited.");s.invites.push({username:t,userId:r}),s.dailyRequests+=1,await s.save()}async getInviteUser(e){return o.findOne({userId:e}).exec()}async canRequest(e){let t=new Date().setHours(0,0,0,0),r=await o.findOne({userId:e});return r||(r=new o({userId:e,lastRequestDate:new Date(0),invites:[],dailyRequests:5}),await r.save()),r.lastRequestDate.setHours(0,0,0,0)!==t&&(r.dailyRequests=5+r.invites.length,r.lastRequestDate=new Date,await r.save()),r.dailyRequests>0}async useRequest(e){let t=await o.findOne({userId:e});if(!t||t.dailyRequests<=0)throw Error("No more requests allowed today.");t.dailyRequests-=1,await t.save()}}let u=new s.Schema({episode:{type:Number,required:!0},shortUrl:{type:String,default:"no link"},teleUrl:{type:String,required:!0}}),l=new s.Schema({shareId:{type:Number,required:!0,unique:!0},messageIds:{type:[Number],required:!0},title:{type:String,required:!0},type:{type:String,enum:["Anime","Movie","Drama","Series","Manga","Other"],required:!0},detail:{type:String,required:!0},posterUrl:{type:String,required:!0},shortUrl:{type:String,required:!0},director:{type:String,default:"Unknown"},screenwriter:{type:String,default:"Unknown"},aired:{type:String,required:!0},duration:{type:String,required:!0},episodes:[u],totalEpisodes:{type:Number,required:!0},tags:{type:String,required:!0},screenshots:{type:[String],default:[]},quality:{type:[String],default:[]},genres:{type:[String],default:[]},rating:{type:Number,default:null},year:{type:Number,default:null},status:{type:String,enum:["Ongoing","Completed","Upcoming"],default:"Ongoing"},trailerUrl:{type:String,default:null},languages:{type:[String],default:"Unknown"},subtitles:{type:[String],default:[]},relatedContent:{type:[String],default:[]}},{timestamps:!0}),c=a().models.aio||a().model("aio",l),g=a().models.message||(0,s.model)("message",new s.Schema({shareId:{type:Number,required:!0,unique:!0},messageIds:{type:[Number],required:!0}})),p=new s.Schema({shareId:{type:Number,required:!0,unique:!0},messageIds:{type:[Number],required:!0},aIOTitle:{type:String,required:!0}},{timestamps:!0}),y=a().models.ongoing||a().model("ongoing",p),h=new s.Schema({shareId:{type:Number,required:!0,unique:!0},aioShortUrl:{type:String,required:!0}},{timestamps:!0}),m=new s.Schema({sort:[h]}),w=a().models.sort||a().model("sort",m),q=new s.Schema({id:{type:Number,required:!0,unique:!0},is_bot:{type:Boolean,required:!0},first_name:{type:String,required:!0},last_name:{type:String},username:{type:String},language_code:{type:String},is_premium:{type:Boolean},added_to_attachment_menu:{type:Boolean}}),O=a().models.user||(0,s.model)("user",q);class f{constructor(){this.db=a(),this.MessageModel=g,this.UserModel=O,this.SortModel=w,this.AIOModel=c,this.OngoingModel=y,this.databaseUrl=i.env.databaseUrl||"",this.inviteService=new d}async initialize(){await this.db.connect(this.databaseUrl)}async saveMessages(e,t){return await new this.MessageModel({shareId:e,messageIds:t}).save(),e}async saveUser(e){try{await this.UserModel.findOne({id:Number(e.id)})||await new this.UserModel(e).save()}catch(e){console.error("Error saving user:",e)}return e}async getAllUserIds(){try{return(await O.find().select("id")).map(e=>e.id)}catch(e){return console.error("Error fetching user IDs:",e),[]}}async isUserExist(e){try{let t=await this.UserModel.findOne({id:Number(e)});return console.log(t),!!t?.id}catch(e){return console.error("Error checking user existence:",e),!1}}async countUsers(){try{let e=await this.UserModel.countDocuments();return`: ${e}`}catch(e){return"Error counting users"}}async saveSort(e){return await new this.SortModel(e).save(),e}async removeFirstItem(){try{let e=await w.findOne({},{sort:{$slice:1}});if(!e||0===e.sort.length)return console.log("No document found or the sort array is empty."),null;let t=e.sort[0];return await w.findOneAndUpdate({_id:e._id},{$pop:{sort:-1}},{new:!0}),t}catch(e){return null}}async getMessages(e){return(await this.MessageModel.findOne({shareId:e}))?.messageIds}async getAIOByShareId(e){return await this.AIOModel.findOne({shareId:e})}async getOngoingMessages(e){return(await this.OngoingModel.findOne({shareId:e}))?.messageIds}async saveAIO(e){return await new this.AIOModel(e).save(),e}async saveOngoing(e){return await new this.OngoingModel(e).save(),e}async searchAIO(e){if(!e.title||e.title.length<2){console.log("Please provide a valid search criteria.");return}let t=e.title.slice(0,20),r={aIOTitle:{$regex:RegExp(t,"i")}},s={};if(t.length>4){let e=t.replace(/\s+/g," ").split(" ").map(e=>`(?=.*${e})`).join("");s={title:{$regex:RegExp(`^${e}`,"i")}}}try{let e=await this.AIOModel.find(r);return 0===e.length&&Object.keys(s).length>0&&(e=await this.AIOModel.find(s)),e}catch(e){console.error("Error executing the query:",e);return}}async searchOngoing(e){if(!e.title||e.title.length<2){console.log("Please provide a valid search criteria.");return}let t=e.title.slice(0,20),r={aIOTitle:{$regex:RegExp(t,"i")}},s={};if(t.length>4){let e=t.replace(/\s+/g," ").split(" ").map(e=>`(?=.*${e})`).join("");s={aIOTitle:{$regex:RegExp(`^${e}`,"i")}}}try{let e=await this.AIOModel.find(r);return 0===e.length&&Object.keys(s).length>0&&(e=await this.AIOModel.find(s)),e}catch(e){console.error("Error executing the query:",e);return}}async getAllAIOPaginated(e,t,r,s){let a={};return"all"!==s&&(a.genres={$in:[s]}),await this.AIOModel.find(a).skip((e-1)*t).limit(t).exec()}async addAIO(e,t){let r=await this.AIOModel.findOne({shareId:e});return!!r&&(await this.AIOModel.findByIdAndUpdate(r.id,{$push:{messageIds:{$each:t}}},{new:!0}),!0)}async deleteAIO(e){let t=await this.AIOModel.findOne({shareId:e});return!!t&&(await this.AIOModel.findByIdAndDelete(t.id),!0)}async updateAIOAttribute(e,t){try{return await c.updateOne({shareId:e},{$set:t}),!0}catch(e){return console.error("Error updating drama attribute:",e),!1}}async getInviteUser(e){return this.inviteService.getInviteUser(e)}async canRequest(e){return this.inviteService.canRequest(e)}async useRequest(e){await this.inviteService.useRequest(e)}}let v=new f}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972],()=>r(8810));module.exports=s})();